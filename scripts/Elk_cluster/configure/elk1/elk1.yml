--- 
- hosts: node_0
  vars_files:
    - ../vars/main.yml
  tasks:
    - name: add repo for java 8
      become: yes
      apt_repository: repo='ppa:webupd8team/java' state=present

    - name: set licence selected
      become: yes
      shell: /bin/echo debconf shared/accepted-oracle-license-v1-1 select true | /usr/bin/debconf-set-selections

    - name: set licence seen
      become: yes
      shell: /bin/echo debconf shared/accepted-oracle-license-v1-1 seen true | /usr/bin/debconf-set-selections

    - name: install java 8
      become: yes
      apt: name=oracle-java8-installer state=latest force=yes

    # Add Elasticsearch apt key

    - name: Add Elasticsearch apt key
      become: true
      apt_key:
       url: "https://packages.elastic.co/GPG-KEY-elasticsearch"
       state: present

    # Add the Elasticsearch apt repo. For versions 6 of the stack - use '6.x-prerelease':
    - name: Adding Elasticsearch repo
      become: true
      apt_repository:
       repo: deb https://artifacts.elastic.co/packages/6.x/apt stable main
       state: present

    #Installing Elasticsearch
    - name: Install Elasticsearch
      become: true
      apt:
       name: elasticsearch
       update_cache: yes

    #Configure elasticsearch 
    - name: Add cluster name into elasticsearch.yml file
      become: true
      lineinfile:
        dest: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#\s*cluster.name: .*$'
        line: 'cluster.name: {{ cluster_name }}'


    - name: Add node name into elasticsearch.yml file
      become: true
      lineinfile:
        dest: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#\s*node.name: .*$'
        line: 'node.name: {{ master_node_name }}'

    - name: Add host ip of master node  into elasticsearch.yml file
      become: true
      lineinfile:
        dest: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#\s*network.host: .*$'
        line: 'network.host: "{{ master_node_host_ip }}"'


    - name: Add second node ip into elasticsearch.yml file
      become: true
      lineinfile:
        dest: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#\s*discovery.zen.ping.unicast.hosts: .*$'
        line: 'discovery.zen.ping.unicast.hosts: ["127.0.0.1", "{{ second_node_ip }}"]'
    
    - name: Restart the service of elk
      become: true
      service: name=elasticsearch state=restarted